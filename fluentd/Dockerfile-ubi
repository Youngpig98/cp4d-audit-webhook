# AUTOMATICALLY GENERATED
# DO NOT EDIT THIS FILE DIRECTLY, USE /Dockerfile.template.erb

FROM  registry.access.redhat.com/ubi8/ubi:latest
LABEL maintainer "Fluentd developers <fluentd@googlegroups.com>"
LABEL Description="Fluentd docker image" Vendor="Fluent Organization" Version="1.10.4"




RUN yum -y install  rpm-build gcc-c++ patch readline zlib zlib-devel libyaml-devel libffi-devel openssl-devel make

COPY ruby-2.5.8.tar.gz  /home

RUN cd /home \
  && tar xzvf ruby-2.5.8.tar.gz \
  && cd ruby-2.5.8 \
  && ./configure  \
  && make \
  && make install \
  && rm -rf /home/* 



#安装插件
RUN echo 'gem: --no-document' >> /etc/gemrc \
 && gem sources --remove https://rubygems.org/ \
 && gem sources -a https://gems.ruby-china.com/ \
 && gem install oj -v 3.8.1 \
 && gem install json -v 2.3.0 \
 && gem install async-http -v 0.50.7 \
 && gem install ext_monitor -v 0.1.2 \
 && gem install fluentd -v 1.10.4 \
 && gem install bigdecimal -v 1.4.4 \
 && gem install fluent-plugin-script -v 0.1.1


RUN rm -rf /usr/local/lib/ruby/gems/2.5.0/gems/fluentd-1.10.4/test/  \
    && groupadd -r fluent && useradd -r -g fluent fluent \
    # for log storage (maybe shared with host)
    && mkdir -p /fluentd/log \
    # configuration/plugins path (default: copied from .)
    && mkdir -p /fluentd/etc /fluentd/plugins \
    && chown -R fluent /fluentd && chgrp -R fluent /fluentd \ 
    && mkdir /home/fluent \
    && cp -a /etc/skel/. /home/fluent

COPY fluent.conf /fluentd/etc/
COPY example.rb /fluentd/etc/
COPY entrypoint.sh /bin/

RUN chmod 777 /bin/entrypoint.sh

ENV FLUENTD_CONF="fluent.conf"

ENV LD_PRELOAD=""
EXPOSE 24224 5140

USER fluent

ENTRYPOINT ["/bin/entrypoint.sh"]
CMD ["fluentd"]