# CP4D-Audit-Webhook

This webhook looks for pod that has `cp4d-audit: "yes"` label and injects the sidecar container to your pod.

## Preqreqs

#### Environmental checklistüßæ

| Configuration item | Specific configuration |
| :----------------: | :--------------------: |
|         OS         |        centos 7        |
|     Kubernetes     |         v1.22+         |

Have Installed the cert-manager operatorÔºàBe care of the version of the operatorÔºâ  ,it will create the secret we need.

**PS:This cert-manager operator is the newest version.**

```shell
kubectl apply -f $(pwd)/deploy/cert-manager.yaml
```



## Steps to install cp4d-audit-webhook

1. Create an issuer

   ```shell
   kubectl apply -f $(pwd)/deploy/issuer.yaml
   ```

   

2. Create a certificateÔºàNote that the dnsName field in the yaml file, the `default` is the namespace where the service is deployed

   ```shell
   kubectl apply -f $(pwd)/deploy/certificate.yaml
   ```
   
   **PS: Watch out the `default` is the namespace!!!!**
   
   ```yaml
   spec:
     dnsNames:
       audit-webhook-service.default.svc
   ```


3. Create ConfigMap„ÄÅService„ÄÅdeployment and Mutatingwebhookconfiguration

   ```shell
   kubectl apply -f $(pwd)/deploy/audit-webhook-configmap.yaml
   kubectl apply -f $(pwd)/deploy/audit-webhook-server-service.yaml
   kubectl apply -f $(pwd)/deploy/audit-webhook-server-deployment.yaml
   kubectl apply -f $(pwd)/deploy/audit-mutating-webhook-configuration.yaml
   ```

   PS: Watch out   the `default` is the namespace!!!!
   In audit-mutating-webhook-configuration.yaml:
      1)„ÄÅcert-manager.io/inject-ca-from: "default/serving-cert"
      2)„ÄÅclientConfig:
            service:
               name: audit-webhook-service
               namespace: default

   ------

   

To test the auditwebhook, apply the logwriter pod example.

```shell
kubectl apply -f $(pwd)/deploy/example/product-configmap.yaml
kubectl apply -f $(pwd)/deploy/example/logwriter.yaml
```

To test the auditwebhook, apply the logwriter pod example.



## To utilize cp4d-audit-webhook

1. Include the label `cp4d-audit: "yes"` in the pod/deployment/statefulset/job type of resource where the audit logs are generated. Inlcude the label in the below mentioned location.

   i) For Pod

   `.metadata.labels`

   iii) For Deployment, StatefulSet, Job

   `.spec.template.metadata.labels`

2. Push the audit logs to the volume named `varlog` [like here](deploy/example/logwriter.yaml)

   ```yaml
   volumes:
   - name: varlog
       emptyDir: {}
   ```

3. Currently the sidecar image is available.

## Log Augmentation and Auditing

‚Äã	The log data generated by the IBM Watson team may not be CloudPak compliant. We compared the public log and private log data and we found the attachments field is missing. So we augment this log field by using the webhook we created.

1. Push your necessary environment variables to the env filed [like here](deploy/example/logwriter.yaml).

```yaml
    - name: NAMESPACE
      valueFrom:
        fieldRef:
          apiVersion: v1
          fieldPath: metadata.namespace
    - name: NODENAME
      valueFrom:
        fieldRef:
          apiVersion: v1
          fieldPath: spec.nodeName
    - name: PODIPADDRESS
      valueFrom:
        fieldRef:
          apiVersion: v1
          fieldPath: status.podIP
    - name: CONTAINERNAME
      value: logwriter
```



‚Äã	The environment variables include NAMESPACE, CONTAINERNAME, NODENAME, PODIPADDRESS and CONTAINERID. 

‚Äã	The first four environment variables can be specified in your pod YAML file. An example is shown in [here](deploy/example/logwriter.yaml).  CONTAINERID, however, needs to be fetched by the logwriter itself. The logwriter will write these environment variables to a file called env. 

‚Äã	The logs and env will be shared to a volume whose type is EmptyDir. The volume will be picked up by the webhook-injected sidecar container later on.


2. The log data is read by a fluentd in_tail plugin in the sidecar container. It also [augments](fluentd/example.rb) the log with the required audit information, and POST it to the stdout.
   More details about Fluentd can be refered [here](fluentd/fluent.conf).

## AuditWebhook

‚Äã	It will receive the message which sent by the mutatingwebhookconfiguration,and set the sidecar container to the loogwriter pod. The auditwebhook was built to a docker image by the [dockerfile](./DOCKERFILE). The source code of the auditwebhook can be seen [here](./audit-webhook).